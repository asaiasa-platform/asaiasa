version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "=== Repository Structure Analysis ==="
        - pwd
        - ls -la
        - echo "Looking for Next.js project..."
        - find . -name "package.json" -type f | head -10
        - echo "=== Installing Dependencies ==="
        - |
          if [ -f "package.json" ] && [ -f "next.config.mjs" ]; then
            echo "Next.js project found at root"
            npm ci
          elif [ -d "website" ] && [ -f "website/package.json" ]; then
            echo "Next.js project found in website directory"
            cd website && npm ci
          else
            echo "ERROR: No Next.js project found!"
            exit 1
          fi
    build:
      commands:
        - echo "=== Building Next.js Application ==="
        - |
          if [ -f "package.json" ] && [ -f "next.config.mjs" ]; then
            echo "Building from root directory"
            npm run build
            echo "Creating redirects"
            echo "/ /en/home 302" > _redirects
            echo "/* /index.html 200" >> _redirects
            cp _redirects .next/
          elif [ -d "website" ]; then
            echo "Building from website directory"
            cd website
            npm run build
            echo "Moving artifacts to root"
            cp -r .next ../
            echo "Creating redirects"
            echo "/ /en/home 302" > ../_redirects
            echo "/* /index.html 200" >> ../_redirects
            cp ../_redirects ../.next/
          else
            echo "ERROR: Cannot find Next.js project to build!"
            exit 1
          fi
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - website/node_modules/**/*
      - website/.next/cache/**/*
  # Environment variables (configure these in Amplify Console)
  # NEXT_PUBLIC_GO_API_URL: https://your-backend-api.com
  # NEXT_PUBLIC_S3_BUCKET1: your-s3-bucket1.s3.amazonaws.com  
  # NEXT_PUBLIC_S3_BUCKET2: your-s3-bucket2.s3.amazonaws.com
  # NEXT_PUBLIC_S3_BUCKET3: your-s3-bucket3.s3.amazonaws.com
  # GOOGLE_CLIENT_ID: your-google-client-id
  # NEXT_PUBLIC_GOOGLE_CLIENT_ID: your-google-client-id
  # NODE_ENV: production
